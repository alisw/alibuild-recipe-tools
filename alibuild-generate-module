#!/bin/sh -ex

# --bin will add $INSTALLROOT/bin to PATH
# --lib will add $INSTALLROOT/lib to LD_LIBRARY_PATH
# --cmake will add $INSTALLROOT to CMAKE_PREFIX_PATH
# --root will add $INSTALLROOT/include to the ROOT_INCLUDE_PATH
HAS_BIN=
HAS_LIB=
HAS_CMAKE=
HAS_ROOT=
while [ "$#" != "0" ]; do
  case $1 in
    --bin) HAS_BIN=true; shift ;;
    --lib) HAS_LIB=true; shift ;;
    --cmake) HAS_CMAKE=true; shift ;;
    --root) HAS_ROOT=true; shift ;;
    *) echo "Unknown option: $1" >&2; exit 1 ;;
  esac
done

cat << EOF
#%Module1.0
proc ModulesHelp { } {
  global version
  puts stderr "ALICE Modulefile for $PKGNAME $PKGVERSION-@@PKGREVISION@$PKGHASH@@"
}
set version $PKGVERSION-@@PKGREVISION@$PKGHASH@@
module-whatis "ALICE Modulefile for $PKGNAME $PKGVERSION-@@PKGREVISION@$PKGHASH@@"
# Dependencies
EOF
printf "if ![ is-loaded 'BASE/1.0' ] {\n module load BASE/1.0\n}"
echo BUILD_REQUIRES="$BUILD_REQUIRES" >&2
FULL_BUILD_REQUIRES=${FULL_BUILD_REQUIRES:-$BUILD_REQUIRES}
echo FULL_BUILD_REQUIRES="$FULL_BUILD_REQUIRES" >&2

# Dependencies
for x in $(env | cut -f1 -d= | grep -v "^DEFAULT_" | grep -v PKGREVISION | grep -v ALIBUILD_RECIPE_TOOLS | grep REVISION | sed -e 's/_REVISION//'); do
  REVISION_VALUE=$(eval "echo \$${x}_REVISION")
  VERSION_VALUE=$(eval "echo \$${x}_VERSION")
  ROOT_PATH_VALUE=$(eval "echo \$${x}_ROOT")

  if [ -z "$REVISION_VALUE" ]; then
    echo "$x" is taken from the system. Skipping loading the associated module. >&2
    continue
  fi

  if echo "$FULL_BUILD_REQUIRES" | tr "[:lower:]" "[:upper:]" | tr "-" "_" | tr " " "\\n" | grep -q "^$x$"; then
    echo "$x" is a build_requires. Skipping loading the associated module. >&2
    continue
  fi

  if [ ! -d "$ROOT_PATH_VALUE/etc/modulefiles" ]; then
    continue
  fi

  for filename in $(find "$ROOT_PATH_VALUE/etc/modulefiles" -type f ! -name '*.*' -print0 | xargs -0 -n1 basename); do
    printf '\nif ![ is-loaded "%s" ] { module load %s }' \
      "${REVISION_LABEL:-$filename/$VERSION_VALUE-$REVISION_VALUE}" \
      "${REVISION_LABEL:-$filename/$VERSION_VALUE-$REVISION_VALUE}"
  done
done
# shellcheck disable=SC2016
case $HAS_BIN-$HAS_LIB-$HAS_CMAKE-$HAS_ROOT in
  ---) ;;
  *) printf '\n\nset PKG_ROOT $::env(BASEDIR)/%s/$version\n' "$PKGNAME" ;;
esac
if [ "$HAS_BIN" = true ]; then 
  printf "prepend-path PATH \$PKG_ROOT/bin\n"
fi
if [ "$HAS_LIB" = true ]; then
  printf "prepend-path LD_LIBRARY_PATH \$PKG_ROOT/lib\n"
fi
if [ "$HAS_CMAKE" = true ]; then
  printf "prepend-path CMAKE_PREFIX_PATH \$PKG_ROOT\n"
fi
if [ "$HAS_ROOT" = true ]; then
  printf "prepend-path ROOT_INCLUDE_PATH \$PKG_ROOT/include\n"
fi
echo
